<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تعديل وتحميل نتائج الطلاب</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            direction: rtl;
            background-color: #f9f9f9;
        }
        select, button, input {
            margin: 10px;
            padding: 10px;
            font-size: 1rem;
        }
        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 90%;
            background-color: #fff;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f0f0f0;
        }
        h1 {
            color: #007BFF;
        }
    </style>
</head>
<body>
    <h1>تعديل وتحميل نتائج الطلاب</h1>

    <!-- اختيار السنة الدراسية -->
    <label for="class">اختر الصف:</label>
    <select id="class">
        <option value="1AS">السنة الأولى</option>
        <option value="2AS">السنة الثانية</option>
        <option value="3AS">السنة الثالثة</option>
        <option value="4AS">السنة الرابعة</option>
    </select>

    <!-- اختيار المادة الدراسية -->
    <label for="subject">اختر المادة:</label>
    <select id="subject">
        <option value="العربية">العربية</option>
        <option value="الرياضيات">الرياضيات</option>
        <option value="الفرنسية">الفرنسية</option>
        <option value="التربية الإسلامية">التربية الإسلامية</option>
        <option value="التاريخ والجغرافيا">التاريخ والجغرافيا</option>
        <option value="الفيزياء والكيمياء">الفيزياء والكيمياء</option>
        <option value="العلوم الطبيعية">العلوم الطبيعية</option>
        <option value="التربية المدنية">التربية المدنية</option>
    </select>

    <button onclick="loadResults()">عرض النتائج</button>

    <div id="results"></div>

    <button id="downloadPdfBtn" style="display:none;" onclick="downloadPdf()">تحميل PDF</button>

    <h2>إدخال نتيجة جديدة</h2>
    <form id="resultForm">
        <label for="studentName">اسم الطالب:</label>
        <input type="text" id="studentName" placeholder="أدخل اسم الطالب" required>
        <label for="score">الدرجة:</label>
        <input type="number" id="score" placeholder="أدخل الدرجة" required>
        <button type="submit">إدخال النتيجة</button>
    </form>

    <script>
        let data = [];

        // تحميل نتائج الطلاب من ملف Excel حسب السنة الدراسية والمادة
        async function loadResults() {
            const selectedClass = document.getElementById('class').value;
            const selectedSubject = document.getElementById('subject').value;

            // رابط ملف Excel بناءً على الصف والمادة المحددة
            const excelUrl = `https://raw.githubusercontent.com/Ghadouri/your-repo/main/${selectedClass}_${selectedSubject}.xlsx`;

            // جلب ملف الإكسل
            const response = await fetch(excelUrl);
            const arrayBuffer = await response.arrayBuffer();

            // قراءة ملف الإكسل
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            data = XLSX.utils.sheet_to_json(sheet);

            // تصفية البيانات حسب المادة والصف
            const filteredData = data.filter(row => row['المادة'] === selectedSubject && row['الصف'] === selectedClass);

            // عرض النتائج
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = generateTable(filteredData);

            // إظهار زر تحميل PDF
            document.getElementById('downloadPdfBtn').style.display = 'inline';
        }

        // توليد الجدول لعرض البيانات
        function generateTable(data) {
            if (data.length === 0) return '<p>لا توجد نتائج</p>';

            let table = '<table><tr>';
            // عرض الأعمدة الخاصة بـ خ1، خ2، خ3، ام1، ام2، ام3، المجموع والمعدل العام
            table += '<th>الاسم</th><th>خ1</th><th>خ2</th><th>خ3</th><th>ام1</th><th>ام2</th><th>ام3</th><th>المجموع</th><th>المعدل العام</th>';
            table += '</tr>';

            data.forEach(row => {
                const total = row["خ1"] + row["خ2"] + row["خ3"] + row["ام1"] + row["ام2"] + row["ام3"];
                const average = total / 6;  // حساب المعدل العام

                table += '<tr>';
                table += `<td>${row["الاسم"]}</td>`;
                table += `<td>${row["خ1"]}</td>`;
                table += `<td>${row["خ2"]}</td>`;
                table += `<td>${row["خ3"]}</td>`;
                table += `<td>${row["ام1"]}</td>`;
                table += `<td>${row["ام2"]}</td>`;
                table += `<td>${row["ام3"]}</td>`;
                table += `<td>${total}</td>`;
                table += `<td>${average.toFixed(2)}</td>`;
                table += '</tr>';
            });

            table += '</table>';
            return table;
        }

        // إضافة النتيجة الجديدة عند تقديم النموذج
        document.getElementById('resultForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const studentName = document.getElementById('studentName').value;
            const score = document.getElementById('score').value;
            const selectedClass = document.getElementById('class').value;
            const selectedSubject = document.getElementById('subject').value;

            // إضافة النتيجة الجديدة إلى البيانات
            data.push({
                "الاسم": studentName,
                "المادة": selectedSubject,
                "خ1": score, // إضافة الدرجة لـ خ1 أو خ2 أو خ3 حسب الاختيار
                "ام1": 0,  // قيم مبدئية (يمكنك تعديلها حسب الحاجة)
                "ام2": 0,
                "ام3": 0,
                "الصف": selectedClass,
                "المجموع": 0,
                "المعدل العام": 0
            });

            // عرض الجدول المحدث
            document.getElementById('results').innerHTML = generateTable(data);

            // مسح الحقول بعد الإدخال
            document.getElementById('resultForm').reset();
        });

        // تنزيل PDF يحتوي على النتائج
        function downloadPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text("نتائج الطلاب في مادة " + document.getElementById('subject').value, 20, 20);

            let y = 30;
            data.forEach(row => {
                const rowData = `الاسم: ${row["الاسم"]} | خ1: ${row["خ1"]} | خ2: ${row["خ2"]} | خ3: ${row["خ3"]} | ام1: ${row["ام1"]} | ام2: ${row["ام2"]} | ام3: ${row["ام3"]} | المجموع: ${row["المجموع"]} | المعدل العام: ${row["المعدل العام"]}`;
                doc.text(rowData, 20, y);
                y += 10;
            });

            doc.save('نتائج_الطلاب.pdf');
        }
    </script>
</body>
</html>
